<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>BPC-SOCIAL</title>
  <style>
    *{margin:0;padding:0;box-sizing:border-box;}
    body{
      font-family:'Segoe UI',sans-serif;
      background:url('mars.png') no-repeat center center fixed;
      background-size:cover;
      color:#fff;min-height:100vh;
    }
    .overlay{background:rgba(139,69,19,.75);min-height:100vh;padding:16px;}
    .header{display:flex;justify-content:space-between;align-items:center;}
    .logo{display:flex;align-items:center;gap:10px;}
    .logo img{width:48px;height:48px;border-radius:50%;box-shadow:0 0 12px rgba(255,255,0,.6);}
    .logo h1{font-size:1.4rem;}
    .logout{
      display:none;background:#e74c3c;color:#fff;border:none;
      border-radius:999px;padding:10px 18px;font-weight:600;cursor:pointer;
    }

    .user-info{margin:10px 0 6px;font-weight:700;}
    .post-form{background:rgba(255,255,255,.12);border-radius:16px;padding:12px;}
    textarea#postContent{
      width:100%;min-height:84px;resize:vertical;border:none;border-radius:12px;
      padding:12px;font-size:1rem;color:#222;background:#fff;
    }
    .post-actions-row{display:flex;gap:10px;align-items:center;margin-top:10px;position:relative;}
    .emoji-toggle{background:#222;color:#fff;border:none;border-radius:20px;padding:10px 16px;cursor:pointer;}
    .send-btn{flex:1;background:#2ecc71;color:#fff;border:none;border-radius:14px;padding:12px 18px;font-weight:700;cursor:pointer;}
    .emoji-panel{position:absolute;left:0;top:50px;width:140px;z-index:100;background:#222;border-radius:12px;padding:8px;display:none;}
    .emoji-panel button{width:100%;background:none;border:none;text-align:left;cursor:pointer;font-size:1.2rem;padding:8px 10px;color:#fff;}

    #posts{margin-top:14px;display:flex;flex-direction:column;gap:12px;}
    .post{background:rgba(255,255,255,.1);border-radius:16px;padding:12px;}
    .post-header{display:flex;gap:10px;align-items:center;margin-bottom:6px;}
    .post-header img{width:36px;height:36px;border-radius:50%;}
    .post-user{font-weight:800;display:flex;align-items:center;gap:6px;}
    .user-badge{background:#000;color:#fff;font-size:.7rem;border-radius:10px;padding:2px 8px;}
    .mod-badge{background:#ff6b6b;color:#fff;font-size:.65rem;padding:2px 6px;border-radius:8px;}
    .post-time{font-size:.8rem;}
    .post-content{background:#fff;color:#222;border-radius:12px;padding:10px;margin:8px 0;}

    .post-actions{display:flex;flex-wrap:wrap;gap:8px;}
    .comment-btn,.emoji-btn,.report-btn,.delete-btn{
      background:#1f9cf0;color:#fff;border:none;border-radius:12px;
      padding:8px 12px;cursor:pointer;font-weight:700;
    }
    .emoji-btn{background:#8e44ad;}
    .report-btn{background:#dc3545;}
    .delete-btn{background:#e67e22;}

    .comment-section{display:none;padding:10px;}
    .comment{background:#fff;color:#222;border-radius:8px;padding:8px 12px;margin:6px 0;font-size:.92rem;}
    .comment-input{display:flex;gap:8px;margin-top:8px;}
    .comment-input input{flex:1;padding:10px;border:none;border-radius:12px;background:#fff;color:#222;}
    .comment-input button{padding:10px 14px;border:none;border-radius:12px;background:#2ecc71;color:#fff;cursor:pointer;}

    .auth{text-align:center;max-width:320px;margin:80px auto 0;}
    .auth button{margin-top:14px;padding:10px 14px;border:none;border-radius:12px;background:#2ecc71;color:#fff;font-weight:700;cursor:pointer;}
  </style>
</head>
<body>
  <div class="overlay">
    <div class="header">
      <div class="logo">
        <img src="bpc-bird.png" alt="BPC Bird">
        <h1>BPC-SOCIAL</h1>
      </div>
      <button class="logout" id="logoutBtn" onclick="logout()">Logout</button>
    </div>

    <div id="auth" class="auth">
      <h2>Join the Community</h2>
      <p><strong>Code:</strong> BPC545776</p>
      <input type="text" id="accessCode" placeholder="Enter code..." style="padding:12px;border-radius:12px;border:none;width:100%;margin:10px 0;">
      <button onclick="loginWithCode()">Login</button>
      <p style="font-size:.8rem;margin-top:10px;">Use the code to get your fixed BPC ID.</p>
    </div>

    <div id="feed" style="display:none;margin-top:10px;">
      <div class="user-info">You: <span id="currentUserId"></span></div>
      <div class="post-form">
        <textarea id="postContent" placeholder="What are you thinking on Mars?"></textarea>
        <div class="post-actions-row">
          <button class="emoji-toggle" onclick="toggleEmojiPanel()">Emoji</button>
          <div id="emojiPanel" class="emoji-panel">
            <button onclick="addEmoji('üëç')">üëç Like</button>
            <button onclick="addEmoji('‚ù§Ô∏è')">‚ù§Ô∏è Heart</button>
            <button onclick="addEmoji('üöÄ')">üöÄ Rocket</button>
            <button onclick="addEmoji('üî•')">üî• Fire</button>
            <button onclick="addEmoji('‚≠ê')">‚≠ê Star</button>
            <button onclick="addEmoji('üòÇ')">üòÇ Laugh</button>
          </div>
          <button class="send-btn" onclick="createPost()">Post</button>
        </div>
      </div>
      <div id="posts"></div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
    import { getDatabase, ref, push, set, onValue, remove, runTransaction } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyB9Xz8f9v5z5v5z5v5z5v5z5v5v5v5v5",
      authDomain: "bpc-social.firebaseapp.com",
      databaseURL: "https://bpc-social-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "bpc-social",
      storageBucket: "bpc-social.appspot.com",
      messagingSenderId: "123456789",
      appId: "1:123456789:web:abcdef123456"
    };

    const app = initializeApp(firebaseConfig);
    const db  = getDatabase(app);
    const postsRef = ref(db,"posts");
    let currentUser=null;
    const MODS=["BPC545776"];

    function generateBPCID(){return `BPC${Math.floor(100000+Math.random()*900000)}`;}

    window.loginWithCode=function(){
      const code=document.getElementById('accessCode').value.trim();
      if(code==="BPC545776"){const id="BPC545776";localStorage.setItem("bpc_user_id",id);initUser(id);}
      else alert("Invalid code!");
    };
    function initUser(id){
      currentUser={id,avatar:"bpc-bird.png"};
      document.getElementById('currentUserId').textContent=id;
      document.getElementById('auth').style.display='none';
      document.getElementById('feed').style.display='block';
      document.getElementById('logoutBtn').style.display='inline-block';
      listenToPosts();
    }
    window.logout=function(){localStorage.removeItem("bpc_user_id");location.reload();}
    window.onload=()=>{const s=localStorage.getItem("bpc_user_id");if(s)initUser(s);};

    window.toggleEmojiPanel=function(){const p=document.getElementById('emojiPanel');p.style.display=p.style.display==='block'?'none':'block';};
    window.addEmoji=function(e){const t=document.getElementById('postContent');t.value+=(t.value?' ':'')+e;toggleEmojiPanel();};

    window.createPost=function(){
      if(!currentUser){alert("Login first.");return;}
      const content=document.getElementById('postContent').value.trim();
      if(!content)return;
      const newRef=push(postsRef);
      set(newRef,{userId:currentUser.id,content,timestamp:Date.now(),comments:{},reactions:{}})
        .then(()=>{document.getElementById('postContent').value='';})
        .catch(err=>{console.error("Post error:",err);alert("Post failed.");});
    };

    function listenToPosts(){
      onValue(postsRef,snap=>{
        const data=snap.val();
        const arr=data?Object.entries(data).map(([id,p])=>({id,...p})):[];
        arr.sort((a,b)=>b.timestamp-a.timestamp);
        renderPosts(arr);
      });
    }

    function renderPosts(posts){
      const c=document.getElementById('posts');
      c.innerHTML=posts.map(p=>{
        const t=new Date(p.timestamp).toLocaleString('en-GB');
        const r=p.reactions||{};
        const mod=MODS.includes(currentUser?.id);
        return `
        <div class="post">
          <div class="post-header">
            <img src="bpc-bird.png"><div>
              <div class="post-user">
                ${escapeHtml(p.userId)}
                ${MODS.includes(p.userId)?'<span class="mod-badge">MOD</span>':''}
                <span class="user-badge">${escapeHtml(p.userId)}</span>
              </div>
              <div class="post-time">${t}</div>
            </div>
          </div>
          <div class="post-content">${escapeHtml(p.content)}</div>
          <div class="post-actions">
            <button class="comment-btn" onclick="toggleComments('${p.id}')">Comment</button>
            <button class="emoji-btn" onclick="addReaction('${p.id}','Like')">üëç ${r['Like']||0}</button>
            <button class="emoji-btn" onclick="addReaction('${p.id}','Heart')">‚ù§Ô∏è ${r['Heart']||0}</button>
            <button class="emoji-btn" onclick="addReaction('${p.id}','Rocket')">üöÄ ${r['Rocket']||0}</button>
            <button class="report-btn" onclick="reportPost('${p.id}')">Report</button>
            ${mod?`<button class="delete-btn" onclick="deletePost('${p.id}')">Delete</button>`:''}
          </div>
          <div id="comments-${p.id}" class="comment-section">
            ${(Object.entries(p.comments||{}).map(([cid,c])=>`
              <div class="comment"><strong>${escapeHtml(c.userId)}:</strong> ${escapeHtml(c.text)} <small>(${c.time})</small></div>`).join(''))}
            <div class="comment-input">
              <input id="comment-input-${p.id}" type="text" placeholder="Write a comment...">
              <button onclick="addComment('${p.id}')">Send</button>
            </div>
          </div>
        </div>`;
      }).join('');
    }

    window.toggleComments=function(id){
      const el=document.getElementById(`comments-${id}`);
      el.style.display=el.style.display==='block'?'none':'block';
    };
    window.addComment=function(id){
      const input=document.getElementById(`comment-input-${id}`);
      const txt=input.value.trim();
      if(!txt||!currentUser)return;
      push(ref(db,`posts/${id}/comments`),{userId:currentUser.id,text:txt,time:new Date().toLocaleString('en-GB',{hour:'2-digit',minute:'2-digit'})});
      input.value='';
    };
    window.addReaction=function(id,type){runTransaction(ref(db,`posts/${id}/reactions/${type}`),c=>(c||0)+1);};
    window.reportPost=function(id){
      if(confirm("Are you sure you want to report this post?")){
        set(ref(db,`reports/${id}`),{userId:currentUser.id,time:Date.now()});
        alert("Reported!");
      }
    };
    window.deletePost=function(id){
      if(!MODS.includes(currentUser?.id))return;
      if(confirm("Delete this post?")) remove(ref(db,`posts/${id}`));
    };
    function escapeHtml(t){const d=document.createElement('div');d.textContent=t;return d.innerHTML;}
  </script>
</body>
</html>
