<!DOCTYPE html>
<html lang="en"><head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Babypeacock • The spark of creativity</title>
<style>
  :root{--ui-bg:#0c0c0c;--ui-fg:#eaeaea}
  html,body{margin:0;height:100%;background:#000;color:#eaeaea;overflow:hidden;
    font-family:system-ui,Segoe UI,monospace;display:flex;justify-content:center;align-items:center}
  canvas{width:100%;max-width:1080px;aspect-ratio:16/9;display:block;border-radius:14px;background:#000}
  .ui{position:fixed;inset:auto 0 0 0;display:flex;gap:.6rem;justify-content:center;flex-wrap:wrap;
      padding:.65rem;background:linear-gradient(#0008,#0000)}
  .ui>*{font:600 14px/1.1 system-ui;border-radius:10px;border:1px solid #333;padding:.6rem .9rem;background:var(--ui-bg);color:var(--ui-fg)}
  button{cursor:pointer} button:active{transform:scale(.98)}
  .note{position:fixed;top:.5rem;right:.5rem;opacity:.6;font:12px/1.1 system-ui}
</style>
</head>
<body>
<canvas id="cv"></canvas>
<div class="ui">
  <button id="preview">Önizleme</button>
  <button id="record">Kaydı Al (WEBM • Sesli)</button>
  <label><input id="sound" type="checkbox" checked> Ses</label>
</div>
<div class="note">Not: bpc-bird.png depo kökünde olmalı</div>

<script>
(() => {
  const cv=document.getElementById('cv'), cx=cv.getContext('2d',{alpha:false});
  const btnPrev=document.getElementById('preview');
  const btnRec=document.getElementById('record');
  const soundChk=document.getElementById('sound');

  // Boyut
  function setSize(w=1920){const W=Math.max(960,Math.min(3840,Math.round(w)));cv.width=W;cv.height=Math.round(W*9/16);}
  setSize(1920); addEventListener('resize',()=>setSize(cv.width));

  // Zaman çizelgesi (ms)
  const TYPE_MS=2400, PAUSE_MS=600, BRIDGE_MS=450, STORM_MS=3400, HOLD_MS=5000;
  const T_TYPE = 0;
  const T_PAUSE = T_TYPE + TYPE_MS;
  const T_BRIDGE = T_PAUSE + PAUSE_MS;
  const T_STORM = T_BRIDGE + BRIDGE_MS;
  const T_END = T_STORM + STORM_MS + HOLD_MS; // toplam süre
  const slogan="The spark of creativity";

  // Kuş görseli
  const raw=new Image(); raw.crossOrigin='anonymous'; raw.src='bpc-bird.png';
  let logo=null; raw.onload=()=>{const off=document.createElement('canvas'),o=off.getContext('2d');
    off.width=raw.naturalWidth;off.height=raw.naturalHeight;o.drawImage(raw,0,0);
    const img=o.getImageData(0,0,off.width,off.height),d=img.data;
    for(let i=0;i<d.length;i+=4){const r=d[i],g=d[i+1],b=d[i+2]; if(r<22&&g<22&&b<22)d[i+3]=0;}
    o.putImageData(img,0,0); logo=off;
  };

  // Ses
  let actx=null,mix=null,bType=null,bTh=null;
  function ensureAudio(){ if(!soundChk.checked) return null;
    if(!actx){ actx=new (window.AudioContext||window.webkitAudioContext)(); }
    if(!mix){ mix=actx.createGain(); mix.gain.value=.9; mix.connect(actx.destination); }
    if(!bType){ bType=actx.createGain(); bType.gain.value=.7; bType.connect(mix); }
    if(!bTh){ bTh=actx.createGain(); bTh.gain.value=.9; bTh.connect(mix); }
    return actx;
  }
  function clickSound(){ if(!ensureAudio())return; const o=actx.createOscillator(), g=actx.createGain();
    o.type='square'; o.frequency.value=880+Math.random()*80;
    g.gain.setValueAtTime(0,actx.currentTime);
    g.gain.linearRampToValueAtTime(.35,actx.currentTime+.005);
    g.gain.exponentialRampToValueAtTime(.0001,actx.currentTime+.08);
    o.connect(g).connect(bType); o.start(); o.stop(actx.currentTime+.09);
  }
  function thunder(){ if(!ensureAudio())return;
    const now=actx.currentTime;
    const sub=actx.createOscillator(); sub.type='sine'; sub.frequency.setValueAtTime(50,now);
    const sg=actx.createGain(); sg.gain.setValueAtTime(0,now); sg.gain.linearRampToValueAtTime(.9,now+.02); sg.gain.exponentialRampToValueAtTime(.0001,now+1.1);
    sub.connect(sg).connect(bTh); sub.start(); sub.stop(now+1.2);
    const cl=actx.sampleRate*.18, cb=actx.createBuffer(1,cl,actx.sampleRate), d=cb.getChannelData(0);
    for(let i=0;i<cl;i++) d[i]=(Math.random()*2-1)*(1-i/cl);
    const cs=actx.createBufferSource(); cs.buffer=cb;
    const bp=actx.createBiquadFilter(); bp.type='bandpass'; bp.frequency.value=3500; bp.Q.value=.8;
    const cg=actx.createGain(); cg.gain.setValueAtTime(0,now); cg.gain.linearRampToValueAtTime(1,now+.01); cg.gain.exponentialRampToValueAtTime(.001,now+.18);
    cs.connect(bp).connect(cg).connect(bTh); cs.start();
    const rl=actx.sampleRate*1.6, rb=actx.createBuffer(1,rl,actx.sampleRate), rbd=rb.getChannelData(0);
    for(let i=0;i<rl;i++) rbd[i]=(Math.random()*2-1)*Math.pow(1-i/rl,1.6);
    const rs=actx.createBufferSource(); rs.buffer=rb;
    const lp=actx.createBiquadFilter(); lp.type='lowpass'; lp.frequency.value=1200;
    const rg=actx.createGain(); rg.gain.setValueAtTime(0,now); rg.gain.linearRampToValueAtTime(.8,now+.04); rg.gain.exponentialRampToValueAtTime(.0001,now+1.55);
    const del=actx.createDelay(.4); del.delayTime.value=.22; const fb=actx.createGain(); fb.gain.value=.27;
    rg.connect(del); del.connect(fb); fb.connect(rg);
    rs.connect(lp).connect(rg).connect(bTh); rs.start();
  }

  // Yardımcılar
  const clamp=(v,a,b)=>Math.max(a,Math.min(b,v));
  const easeOutCubic=t=>1-Math.pow(1-t,3);
  const easeInOutQuad=t=>t<.5?2*t*t:1-Math.pow(-2*t+2,2)/2;

  // Yıldırım çizimi
  function bolt(x,y0,y1){
    cx.save(); cx.globalCompositeOperation='screen'; cx.lineCap='round';
    const seg=12, pts=[[x,y0]]; let px=x,py=y0,tot=y1-y0;
    for(let i=1;i<=seg;i++){const t=i/seg; const nx=px+(Math.random()-.5)*tot*.03*(1-t);
      const ny=y0+t*tot+(Math.random()-.5)*15*(1-t); pts.push([nx,ny]); px=nx; py=ny;}
    cx.strokeStyle='rgba(255,255,255,.95)'; cx.shadowColor='rgba(170,220,255,.9)'; cx.shadowBlur=28; cx.lineWidth=6;
    cx.beginPath(); cx.moveTo(pts[0][0],pts[0][1]); for(const p of pts)cx.lineTo(p[0],p[1]); cx.stroke();
    cx.strokeStyle='rgba(80,170,255,.9)'; cx.shadowColor='rgba(120,200,255,.9)'; cx.shadowBlur=40; cx.lineWidth=2.5;
    cx.beginPath(); cx.moveTo(pts[0][0],pts[0][1]); for(const p of pts)cx.lineTo(p[0],p[1]); cx.stroke();
    cx.restore();
  }

  // Tek çizim fonksiyonu — zamanı parametre alır (ms)
  function renderAt(t){
    const W=cv.width,H=cv.height; cx.clearRect(0,0,W,H); // kare temiz
    if(t < T_PAUSE){ // daktilo
      const span = t - T_TYPE; const charMs = TYPE_MS / slogan.length;
      const n = Math.max(0, Math.min(slogan.length, Math.floor(span/charMs)));
      const typed = slogan.slice(0,n);
      const fs=Math.round(H*0.08);
      cx.fillStyle='#eaeaea'; cx.font=fs+'px monospace'; cx.textAlign='center'; cx.textBaseline='middle';
      cx.fillText(typed, W/2, H/2);
      // caret
      const caretOn = Math.floor(span/200)%2===0;
      const w=cx.measureText(typed).width;
      if(n<slogan.length || caretOn) cx.fillRect(W/2+w/2+8, H/2-fs*0.55, 6, fs*1.1);
      return;
    }
    if(t < T_BRIDGE){ // kısa siyah köprü
      cx.fillStyle='#000'; cx.fillRect(0,0,W,H); return;
    }
    // Fırtına sahnesi
    const elapsed = clamp(t - T_STORM, 0, STORM_MS + HOLD_MS);
    cx.fillStyle='#000'; cx.fillRect(0,0,W,H);
    let ambient=0; if(elapsed>1500){const k=clamp((elapsed-1500)/(3300-1500),0,1); ambient=easeInOutQuad(k)*.55;}
    const g=cx.createRadialGradient(W/2,H/2,0,W/2,H/2,W*0.9);
    g.addColorStop(0,`rgba(180,220,255,${0.06+ambient*0.35})`); g.addColorStop(1,'rgba(0,0,0,0)');
    cx.fillStyle=g; cx.fillRect(0,0,W,H);
    if(elapsed<900){ const n=2+Math.floor(Math.random()*2);
      for(let i=0;i<n;i++){ const sx=W*0.2+Math.random()*W*0.6; bolt(sx,-60,H*0.55); }
      cx.fillStyle='rgba(255,255,255,.32)'; cx.fillRect(0,0,W,H);
    }
    if(logo){ const appear=clamp((elapsed-1000)/1200,0,1), a=easeOutCubic(appear);
      const base=H*0.5, pulse=1+Math.sin(elapsed/1000*1.6)*0.03*(appear>0?1:0);
      cx.save(); cx.globalAlpha=a; cx.translate(W/2,H*0.55); cx.shadowColor='rgba(180,220,255,.45)'; cx.shadowBlur=W*0.025; cx.scale(pulse,pulse);
      cx.drawImage(logo,-base/2,-base/2,base,base); cx.restore(); }
    cx.fillStyle='#eaf2ff'; cx.textAlign='center'; cx.font=Math.round(H*0.08)+'px system-ui,Segoe UI,Arial';
    cx.globalAlpha=clamp((elapsed-1000)/1200,0,1); cx.fillText('Babypeacock',W/2,H*0.18); cx.globalAlpha=1;
    if(typeof cx.createConicGradient==='function'){ const glow=clamp((elapsed-1600)/1400,0,1);
      if(glow>0){ cx.save(); cx.translate(W/2,H/2); cx.globalAlpha=glow*.6; cx.lineWidth=W*0.015;
        const ring=cx.createConicGradient((elapsed/1000)*0.2,0,0); ring.addColorStop(0,'#cfe9ff'); ring.addColorStop(1,'#66b2ff');
        cx.strokeStyle=ring; cx.shadowColor='rgba(150,200,255,.5)'; cx.shadowBlur=W*0.02; cx.beginPath(); cx.arc(0,0,H*0.27,0,Math.PI*2); cx.stroke(); cx.restore(); }
    }
  }

  // Önizleme (raf tabanlı) — sadece ekrandaki animasyon
  let raf=0, prevStart=0, lastPhaseThundered=false;
  function startPreview(){
    cancelAnimationFrame(raf);
    prevStart=performance.now(); lastPhaseThundered=false;
    if(soundChk.checked){ ensureAudio()?.resume?.(); }
    const loop=()=>{
      const t = performance.now() - prevStart;
      renderAt(t);
      // Şimşek sfx'i sadece T_STORM anında bir kez tetikleyelim
      if(t>=T_STORM && !lastPhaseThundered){ lastPhaseThundered=true; thunder(); }
      if(t<T_END) raf=requestAnimationFrame(loop);
    };
    loop();
  }

  // WEBM mime seçici
  function pickWebmMime() {
    const cands = [
      'video/webm;codecs=vp9,opus',
      'video/webm;codecs=vp8,opus',
      'video/webm;codecs=vp9',
      'video/webm;codecs=vp8',
      'video/webm'
    ];
    for (const m of cands) { if (MediaRecorder.isTypeSupported?.(m)) return m; }
    return 'video/webm';
  }

  // Kayıt — deterministik 60fps çerçeve üretimi
  async function recordOnce(){
    if(!window.MediaRecorder){ alert('Tarayıcın MediaRecorder desteklemiyor.'); return; }
    cancelAnimationFrame(raf); // preview dursun
    ensureAudio()?.resume?.();

    const FPS=60;
    const stream=cv.captureStream(FPS);
    // Ses
    if(soundChk.checked && actx){
      const dest=actx.createMediaStreamDestination();
      mix.disconnect(); mix.connect(dest); mix.connect(actx.destination);
      stream.addTrack(dest.stream.getAudioTracks()[0]);
    }
    // Recorder
    let mime=pickWebmMime(); let rec;
    try{ rec=new MediaRecorder(stream,{mimeType:mime,videoBitsPerSecond:7_000_000}); }
    catch(e){ rec=new MediaRecorder(stream); mime='video/webm'; }

    let chunks=[]; rec.ondataavailable=e=>{ if(e.data && e.data.size) chunks.push(e.data); };
    rec.start();

    // Ses olayları: yazı klikleri ve şimşek
    const charMs = TYPE_MS / slogan.length;
    let lastClickIdx=-1, thunderDone=false;

    // Deterministik render döngüsü
    const dt=1000/FPS; let t=0;
    const timer=setInterval(()=>{
      // klik sesleri
      const idx = Math.floor(clamp(t - T_TYPE, 0, TYPE_MS)/charMs)-1;
      if(soundChk.checked && idx>lastClickIdx && t<T_PAUSE){ lastClickIdx=idx; clickSound(); }
      // thunder
      if(soundChk.checked && t>=T_STORM && !thunderDone){ thunderDone=true; thunder(); }
      renderAt(t);
      t += dt;
      if(t>=T_END){
        clearInterval(timer);
        setTimeout(()=>rec.stop(), 100); // son tampon
      }
    }, dt);

    rec.onstop=()=>{ const blob=new Blob(chunks,{type:mime});
      const url=URL.createObjectURL(blob); const a=document.createElement('a');
      a.href=url; a.download='bpc-intro.webm'; document.body.appendChild(a); a.click();
      a.remove(); URL.revokeObjectURL(url);
    };
  }

  // UI
  btnPrev.onclick=startPreview;
  btnRec.onclick=recordOnce;

  // Otomatik önizleme
  startPreview();
})();
</script>
</body>
</html>
