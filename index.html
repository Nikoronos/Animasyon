<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>BPC-SOCIAL</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: url('mars.png') no-repeat center center fixed;
      background-size: cover;
      color: #fff;
      min-height: 100vh;
      position: relative;
      margin: 0;
    }
    .overlay {
      background: rgba(139, 69, 19, 0.75);
      min-height: 100vh;
      padding: 15px;
    }
    .header {
      display: flex; justify-content: space-between; align-items: center;
      margin-bottom: 15px; position: relative; z-index: 10;
    }
    .logo {
      display: flex; align-items: center; gap: 10px;
    }
    .logo img {
      width: 50px; height: 50px; border-radius: 50%;
      border: 2px solid #FFD700; box-shadow: 0 0 10px rgba(255, 215, 0, 0.6);
    }
    .logo h1 {
      font-size: 1.4rem; text-shadow: 0 0 8px #000;
    }
    .logout {
      background: #dc3545; color: #fff; border: none;
      padding: 8px 16px; border-radius: 20px; font-size: .9rem;
      cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,.3);
      display: none;
    }
    .user-info {
      text-align: center; margin: 10px 0; font-size: 1rem; font-weight: bold;
    }
    .post-form {
      max-width: 100%; margin: 0 auto 20px;
    }
    textarea {
      width: 100%; padding: 12px; border: none; border-radius: 12px;
      background: rgba(255,255,255,.9); color: #333; font-size: 1rem;
      min-height: 80px; resize: none; margin-bottom: 10px;
    }
    button {
      background: #28a745; color: #fff; border: none; padding: 12px 20px;
      border-radius: 12px; font-size: 1rem; cursor: pointer; width: 100%;
      font-weight: bold;
    }
    button:hover { background: #218838; }
    .post {
      background: rgba(255,255,255,.15); border-radius: 15px; padding: 15px;
      margin: 15px 0; backdrop-filter: blur(8px);
      border: 1px solid rgba(255,255,255,.2); max-width: 100%;
    }
    .post-header {
      display: flex; align-items: center; gap: 10px; margin-bottom: 10px;
    }
    .post-header img {
      width: 40px; height: 40px; border-radius: 50%;
    }
    .post-user {
      font-weight: bold; font-size: .95rem;
    }
    .user-badge {
      background: #007bff; color: #fff; font-size: .7rem;
      padding: 2px 8px; border-radius: 12px; margin-left: 5px;
    }
    .post-time {
      font-size: .75rem; opacity: .85;
    }
    .post-content {
      margin: 10px 0; line-height: 1.5; font-size: 1rem; word-wrap: anywhere;
    }
    .post-actions {
      display: flex; gap: 8px; margin-top: 12px; flex-wrap: wrap;
    }
    .emoji-btn {
      background: rgba(0,0,0,.15); border: 1px solid rgba(255,255,255,.25);
      font-size: 1.1rem; cursor: pointer; padding: 6px 10px;
      border-radius: 16px; width: auto;
    }
    .comment-btn {
      background: #28a745; color: #fff; padding: 8px 16px;
      border-radius: 20px; font-size: .9rem; width: auto;
    }
    .comment-section {
      margin-top: 12px; background: rgba(0,0,0,.2);
      border-radius: 10px; padding: 10px; display: none;
    }
    .comment {
      background: rgba(255,255,255,.1); padding: 8px 12px;
      border-radius: 8px; margin: 6px 0; font-size: .9rem;
    }
    .comment-input {
      display: flex; gap: 8px; margin-top: 10px;
    }
    .comment-input input {
      flex: 1; padding: 10px; border: none; border-radius: 20px;
      background: #fff; color: #333; font-size: .9rem;
    }
    .comment-input button {
      width: auto; padding: 10px 16px; font-size: .9rem;
    }
    .drone {
      position: fixed; left: 50%; transform: translateX(-50%);
      bottom: 10px; width: 120px; height: auto; z-index: 5;
      pointer-events: none; animation: floatY 3.5s ease-in-out infinite;
      filter: drop-shadow(0 6px 12px rgba(0,0,0,0.6));
    }
    @keyframes floatY {
      0%, 100% { transform: translate(-50%, 0); }
      50% { transform: translate(-50%, -10px); }
    }
    .auth {
      text-align: center; max-width: 300px; margin: 100px auto 0;
    }
    .auth button {
      margin-top: 20px;
    }
    .emoji-panel {
      position: absolute; background: #222; border-radius: 12px;
      padding: 10px; display: none; z-index: 100;
      box-shadow: 0 4px 12px rgba(0,0,0,0.5);
    }
    .emoji-panel button {
      background: none; border: none; font-size: 1.5rem;
      padding: 8px; cursor: pointer;
    }
    .report-btn, .delete-btn {
      background: #dc3545; color: #fff; border: none;
      padding: 6px 10px; border-radius: 12px; font-size: 0.8rem;
      margin-left: 5px;
    }
    .mod-badge {
      background: #ff6b6b; color: #fff; font-size: 0.6rem;
      padding: 2px 6px; border-radius: 8px; margin-left: 5px;
    }
    @media (max-width: 480px) {
      .header { padding: 0 10px; }
      .logo h1 { font-size: 1.2rem; }
      .logout { font-size: .8rem; padding: 6px 12px; }
      .drone { width: 90px; }
    }
  </style>
</head>
<body>
  <div class="overlay">
    <!-- Header -->
    <div class="header">
      <div class="logo">
        <img src="bpc-bird.png" alt="BPC Kuş"/>
        <h1>BPC-SOCIAL</h1>
      </div>
      <button class="logout" id="logoutBtn" onclick="logout()">Çıkış</button>
    </div>

    <!-- Giriş -->
    <div id="auth" class="auth">
      <h2>Topluluğa Katıl</h2>
      <p><strong>Kod:</strong> BPC545776</p>
      <input type="text" id="accessCode" placeholder="Kodu gir..." style="padding:12px; border-radius:12px; border:none; width:100%; margin:10px 0;"/>
      <button onclick="loginWithCode()">Giriş Yap</button>
      <p style="font-size:0.8rem; margin-top:10px;">Kod ile sabit BPC ID alırsın.</p>
    </div>

    <!-- Feed -->
    <div id="feed" style="display:none; margin-top:10px;">
      <div class="user-info">Sen: <span id="currentUserId"></span></div>
      <div class="post-form">
        <textarea id="postContent" placeholder="Mars'ta ne düşünüyorsun?"></textarea>
        <div style="position:relative; display:inline-block;">
          <button onclick="toggleEmojiPanel()">Emoji</button>
          <div id="emojiPanel" class="emoji-panel">
            <button onclick="addEmoji('Like')">Like</button>
            <button onclick="addEmoji('Heart')">Heart</button>
            <button onclick="addEmoji('Rocket')">Rocket</button>
            <button onclick="addEmoji('Fire')">Fire</button>
            <button onclick="addEmoji('Star')">Star</button>
            <button onclick="addEmoji('Laugh')">Laugh</button>
          </div>
        </div>
        <button onclick="createPost()">Gönder</button>
      </div>
      <div id="posts"></div>
    </div>
  </div>

  <!-- Drone yerine assets.png -->
  <img src="assets.png" alt="Assets" class="drone"/>

  <!-- Firebase RTDB -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
    import { getDatabase, ref, push, onValue, remove, runTransaction } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyB9Xz8f9v5z5v5z5v5z5v5z5v5z5v5z5v5",
      authDomain: "bpc-social.firebaseapp.com",
      databaseURL: "https://bpc-social-default-rtdb.eur.firebasedatabase.app",
      projectId: "bpc-social",
      storageBucket: "bpc-social.appspot.com",
      messagingSenderId: "123456789",
      appId: "1:123456789:web:abcdef123456"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const postsRef = ref(db, 'posts');

    let currentUser = null;
    const MODERATORS = ["BPC545776"];

    function generateBPCID() {
      return `BPC${Math.floor(100000 + Math.random() * 900000)}`;
    }

    window.loginWithCode = function() {
      const code = document.getElementById('accessCode').value.trim();
      if (code === "BPC545776") {
        const userId = "BPC545776";
        localStorage.setItem('bpc_user_id', userId);
        initUser(userId);
      } else {
        alert("Geçersiz kod!");
      }
    };

    window.createUser = function() {
      let userId = localStorage.getItem('bpc_user_id');
      if (!userId) {
        userId = generateBPCID();
        localStorage.setItem('bpc_user_id', userId);
      }
      initUser(userId);
    };

    function initUser(userId) {
      currentUser = { id: userId, avatar: "bpc-bird.png" };
      document.getElementById('currentUserId').textContent = userId;
      document.getElementById('auth').style.display = 'none';
      document.getElementById('feed').style.display = 'block';
      document.getElementById('logoutBtn').style.display = 'inline-block';
      listenToPosts();
    }

    window.logout = function() {
      localStorage.removeItem('bpc_user_id');
      location.reload();
    };

    window.toggleEmojiPanel = function() {
      const panel = document.getElementById('emojiPanel');
      panel.style.display = panel.style.display === 'block' ? 'none' : 'block';
    };

    window.addEmoji = function(emoji) {
      const textarea = document.getElementById('postContent');
      textarea.value += ` ${emoji}`;
      toggleEmojiPanel();
    };

    // GÖNDERİ OLUŞTUR – PUSH + ID EKLE
    window.createPost = function() {
      const content = document.getElementById('postContent').value.trim();
      if (!content) return alert("Boş gönderi olamaz!");

      const newPostRef = push(postsRef);
      const post = {
        userId: currentUser.id,
        content,
        timestamp: Date.now(),
        comments: {},
        reactions: {}
      };

      set(newPostRef, post).then(() => {
        document.getElementById('postContent').value = '';
      }).catch(err => {
        console.error("Gönderi hatası:", err);
        alert("Gönderi eklenemedi. Konsolu kontrol et.");
      });
    };

    function listenToPosts() {
      onValue(postsRef, (snapshot) => {
        const data = snapshot.val();
        const posts = data ? Object.entries(data).map(([id, p]) => ({ id, ...p })) : [];
        posts.sort((a, b) => b.timestamp - a.timestamp);
        renderPosts(posts);
      }, (error) => {
        console.error("RTDB Hatası:", error);
      });
    }

    function renderPosts(posts) {
      const container = document.getElementById('posts');
      container.innerHTML = posts.map(post => {
        const time = new Date(post.timestamp).toLocaleString('tr-TR');
        const reactions = post.reactions || {};
        const isMod = MODERATORS.includes(currentUser?.id);

        return `
          <div class="post">
            <div class="post-header">
              <img src="bpc-bird.png" />
              <div>
                <div class="post-user">
                  ${escapeHtml(post.userId)}
                  ${MODERATORS.includes(post.userId) ? '<span class="mod-badge">MOD</span>' : ''}
                  <span class="user-badge">${escapeHtml(post.userId)}</span>
                </div>
                <div class="post-time">${time}</div>
              </div>
            </div>
            <div class="post-content">${escapeHtml(post.content)}</div>
            <div class="post-actions">
              <button class="comment-btn" onclick="toggleComments('${post.id}')">Yorum Yap</button>
              <button class="emoji-btn" onclick="addReaction('${post.id}', 'Like')">Like ${reactions['Like'] || 0}</button>
              <button class="emoji-btn" onclick="addReaction('${post.id}', 'Heart')">Heart ${reactions['Heart'] || 0}</button>
              <button class="emoji-btn" onclick="addReaction('${post.id}', 'Rocket')">Rocket ${reactions['Rocket'] || 0}</button>
              <button class="report-btn" onclick="reportPost('${post.id}')">Rapor</button>
              ${isMod ? `<button class="delete-btn" onclick="deletePost('${post.id}')">Sil</button>` : ''}
            </div>
            <div id="comments-${post.id}" class="comment-section">
              ${Object.entries(post.comments || {}).map(([cid, c]) => `
                <div class="comment">
                  <strong>${escapeHtml(c.userId)}:</strong> ${escapeHtml(c.text)} <small>(${c.time})</small>
                </div>
              `).join('')}
              <div class="comment-input">
                <input type="text" id="comment-input-${post.id}" placeholder="Yorum yaz..." />
                <button onclick="addComment('${post.id}')">Gönder</button>
              </div>
            </div>
          </div>
        `;
      }).join('');
    }

    window.addComment = function(postId) {
      const input = document.getElementById(`comment-input-${postId}`);
      const text = input.value.trim();
      if (!text) return;

      const commentRef = ref(db, `posts/${postId}/comments`);
      push(commentRef, {
        userId: currentUser.id,
        text,
        time: new Date().toLocaleString('tr-TR', { hour: '2-digit', minute: '2-digit' })
      });
      input.value = '';
    };

    window.addReaction = function(postId, type) {
      const reactionRef = ref(db, `posts/${postId}/reactions/${type}`);
      runTransaction(reactionRef, (current) => (current || 0) + 1);
    };

    window.reportPost = function(postId) {
      if (confirm("Rapor etmek istediğine emin misin?")) {
        const reportRef = ref(db, `reports/${postId}`);
        set(reportRef, { userId: currentUser.id, time: Date.now() });
        alert("Raporlandı!");
      }
    };

    window.deletePost = function(postId) {
      if (confirm("Silmek istediğine emin misin?")) {
        remove(ref(db, `posts/${postId}`));
      }
    };

    window.toggleComments = function(id) {
      const el = document.getElementById(`comments-${id}`);
      el.style.display = el.style.display === 'block' ? 'none' : 'block';
    };

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    window.onload = () => {
      const savedId = localStorage.getItem('bpc_user_id');
      if (savedId) {
        initUser(savedId);
      }
    };
  </script>
</body>
</html>
