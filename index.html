<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>BPC-SOCIAL</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body{
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: url('mars.png') no-repeat center center fixed;
      background-size: cover;
      color:#fff; min-height:100vh; position:relative;
    }
    .overlay{
      background: rgba(139,69,19,0.72);
      min-height:100vh; padding:15px;
    }
    .header{ display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; position:relative; z-index:10; }
    .logo{ display:flex; align-items:center; gap:10px; }
    .logo img{ width:50px; height:50px; border-radius:50%; border:2px solid #FFD700; box-shadow:0 0 10px rgba(255,215,0,0.6); }
    .logo h1{ font-size:1.4rem; text-shadow:0 0 8px #000; }
    .logout{ background:#dc3545; color:#fff; border:none; padding:8px 16px; border-radius:20px; font-size:.9rem; cursor:pointer; box-shadow:0 2px 5px rgba(0,0,0,.3); display:none; }
    .user-info{ text-align:center; margin:10px 0; font-size:1rem; font-weight:bold; }
    .post-form{ max-width:100%; margin:0 auto 20px; }
    textarea{
      width:100%; padding:12px; border:none; border-radius:12px;
      background:rgba(255,255,255,.9); color:#333; font-size:1rem; min-height:80px; resize:none; margin-bottom:10px;
    }
    button{ background:#28a745; color:#fff; border:none; padding:12px 20px; border-radius:12px; font-size:1rem; cursor:pointer; width:100%; font-weight:bold; }
    button:hover{ background:#218838; }
    .post{
      background:rgba(255,255,255,.15); border-radius:15px; padding:15px; margin:15px 0;
      backdrop-filter: blur(8px); border:1px solid rgba(255,255,255,.2); max-width:100%;
    }
    .post-header{ display:flex; align-items:center; gap:10px; margin-bottom:10px; }
    .post-header img{ width:40px; height:40px; border-radius:50%; }
    .post-user{ font-weight:bold; font-size:.95rem; }
    .user-badge{ background:#007bff; color:#fff; font-size:.7rem; padding:2px 8px; border-radius:12px; margin-left:5px; }
    .post-time{ font-size:.75rem; opacity:.85; }
    .post-content{ margin:10px 0; line-height:1.5; font-size:1rem; word-wrap:anywhere; }
    .post-actions{ display:flex; gap:8px; margin-top:12px; flex-wrap:wrap; }
    .emoji-btn{ background:rgba(0,0,0,.15); border:1px solid rgba(255,255,255,.25); font-size:1.1rem; cursor:pointer; padding:6px 10px; border-radius:16px; width:auto; }
    .comment-btn{ background:#28a745; color:#fff; padding:8px 16px; border-radius:20px; font-size:.9rem; width:auto; }
    .comment-section{ margin-top:12px; background:rgba(0,0,0,.2); border-radius:10px; padding:10px; display:none; }
    .comment{ background:rgba(255,255,255,.1); padding:8px 12px; border-radius:8px; margin:6px 0; font-size:.9rem; }
    .comment-input{ display:flex; gap:8px; margin-top:10px; }
    .comment-input input{ flex:1; padding:10px; border:none; border-radius:20px; background:#fff; color:#333; font-size:.9rem; }
    .comment-input button{ width:auto; padding:10px 16px; font-size:.9rem; }

    /* Drone animasyonu (PNG arkasƒ± ≈üeffaf olmalƒ±) */
    .drone{
      position:fixed; left:50%; transform:translateX(-50%);
      bottom:10px; width:120px; height:auto; z-index:5; pointer-events:none;
      animation: floatY 3.5s ease-in-out infinite;
      filter: drop-shadow(0 6px 12px rgba(0,0,0,0.6));
    }
    @keyframes floatY{
      0%,100%{ transform:translate(-50%, 0); }
      50%{ transform:translate(-50%, -10px); }
    }

    .auth{ text-align:center; max-width:300px; margin:100px auto 0; }
    .auth button{ margin-top:20px; }

    @media (max-width:480px){
      .header{ padding:0 10px; }
      .logo h1{ font-size:1.2rem; }
      .logout{ font-size:.8rem; padding:6px 12px; }
      .drone{ width:90px; }
    }
  </style>
</head>
<body>
  <div class="overlay">
    <!-- Header -->
    <div class="header">
      <div class="logo">
        <img src="bpc-bird.png" alt="BPC Ku≈ü"/>
        <h1>BPC-SOCIAL</h1>
      </div>
      <button class="logout" id="logoutBtn" onclick="logout()">√áƒ±kƒ±≈ü</button>
    </div>

    <!-- Giri≈ü -->
    <div id="auth" class="auth">
      <h2>Topluluƒüa Katƒ±l</h2>
      <p>Her giri≈üte sana √∂zel BPC ID verilir!</p>
      <button onclick="createUser()">Giri≈ü Yap</button>
    </div>

    <!-- Feed -->
    <div id="feed" style="display:none; margin-top:10px;">
      <div class="user-info">Sen: <span id="currentUserId"></span></div>
      <div class="post-form">
        <textarea id="postContent" placeholder="Mars'ta ne d√º≈ü√ºn√ºyorsun?"></textarea>
        <button onclick="createPost()">G√∂nder</button>
      </div>
      <div id="posts"></div>
    </div>
  </div>

  <!-- Drone -->
  <img src="drone.png" alt="Drone" class="drone"/>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

  <script>
    // === FIREBASE CONFIGƒ∞Nƒ∞ BURAYA KOY ===
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_PROJECT.firebaseapp.com",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_PROJECT.appspot.com",
      messagingSenderId: "123456789",
      appId: "1:123456789:web:abcdef123456"
    };

    let db = null;
    let useFirebase = false;

    // Firebase ba≈ülatmayƒ± dene; ba≈üarƒ±sƒ±zsa localStorage moduna ge√ß
    try {
      firebase.initializeApp(firebaseConfig);
      db = firebase.firestore();
      useFirebase = !!firebaseConfig && !!firebaseConfig.projectId && firebaseConfig.projectId !== "YOUR_PROJECT_ID";
    } catch (e) {
      console.log("Firebase ba≈ülatƒ±lamadƒ±, localStorage kullanƒ±lacak.", e);
      useFirebase = false;
    }

    // State
    let currentUser = null;
    let posts = JSON.parse(localStorage.getItem('bpc_posts') || '[]');

    // ID √ºretici
    function generateBPCID(){
      const num = Math.floor(100000 + Math.random() * 900000);
      return `BPC${num}`;
    }

    // Kullanƒ±cƒ± olu≈ütur / giri≈ü
    function createUser(){
      let userId = localStorage.getItem('bpc_user_id');
      if(!userId){
        userId = generateBPCID();
        localStorage.setItem('bpc_user_id', userId);
      }
      currentUser = { id: userId, avatar: "bpc-bird.png" };
      document.getElementById('currentUserId').textContent = userId;
      document.getElementById('auth').style.display = 'none';
      document.getElementById('feed').style.display = 'block';
      document.getElementById('logoutBtn').style.display = 'inline-block';
      if(useFirebase){
        listenToPosts();
      } else {
        renderPosts();
      }
    }

    function logout(){
      localStorage.removeItem('bpc_user_id');
      location.reload();
    }

    // G√∂nderi olu≈ütur
    async function createPost(){
      if(!currentUser){ return alert("√ñnce giri≈ü yap."); }
      const contentEl = document.getElementById('postContent');
      const content = contentEl.value.trim();
      if(!content){ return alert("Bo≈ü g√∂nderi olamaz!"); }

      const post = {
        // Firestore'da doƒüru sƒ±ralama i√ßin numeric createdAt
        createdAt: Date.now(),
        timestampISO: new Date().toISOString(),
        userId: currentUser.id,
        avatar: currentUser.avatar,
        content,
        comments: [],
        reactions: { "üëç": 0, "‚ù§Ô∏è": 0, "üöÄ": 0 }
      };

      try{
        if(useFirebase){
          // doc id'yi al ve post i√ßine yaz (ileride yorum/reaksiyon i√ßin ≈üart)
          const docRef = await db.collection('posts').add(post);
          await db.collection('posts').doc(docRef.id).update({ id: docRef.id });
          // Anlƒ±k render gerekmiyor; onSnapshot zaten √ßekecek
        } else {
          post.id = String(post.createdAt);
          posts.unshift(post);
          localStorage.setItem('bpc_posts', JSON.stringify(posts));
          renderPosts();
        }
        contentEl.value = '';
      }catch(err){
        console.error(err);
        alert("G√∂nderi olu≈üturulurken bir hata olu≈ütu.");
      }
    }

    // Firestore ger√ßek zamanlƒ± dinleme
    function listenToPosts(){
      db.collection('posts').orderBy('createdAt', 'desc')
        .onSnapshot(snap=>{
          posts = snap.docs.map(d => ({ id: d.id, ...d.data() }));
          renderPosts();
        }, err=>{
          console.error(err);
          // Hata olursa local moda d√∂n
          useFirebase = false;
          loadLocalAndRender();
        });
    }

    function loadLocalAndRender(){
      posts = JSON.parse(localStorage.getItem('bpc_posts') || '[]');
      renderPosts();
    }

    // Yorum ekle
    async function addComment(postId){
      const input = document.getElementById(`comment-input-${postId}`);
      if(!input) return;
      const text = input.value.trim();
      if(!text) return;

      const comment = {
        userId: currentUser?.id || "Anon",
        text,
        time: new Date().toLocaleString('tr-TR', { hour: '2-digit', minute: '2-digit' })
      };

      try{
        if(useFirebase){
          const postRef = db.collection('posts').doc(postId);
          await postRef.update({
            comments: firebase.firestore.FieldValue.arrayUnion(comment)
          });
        } else {
          const p = posts.find(p=>p.id===postId);
          if(!p) return;
          p.comments.push(comment);
          localStorage.setItem('bpc_posts', JSON.stringify(posts));
          renderPosts();
        }
        input.value = '';
      }catch(err){
        console.error(err);
        alert("Yorum eklenemedi.");
      }
    }

    // Emoji tepkisi ekle
    async function addReaction(postId, emoji){
      try{
        if(useFirebase){
          const postRef = db.collection('posts').doc(postId);
          const key = `reactions.${emoji}`;
          await postRef.update({
            [key]: firebase.firestore.FieldValue.increment(1)
          });
        } else {
          const p = posts.find(p=>p.id===postId);
          if(!p) return;
          p.reactions[emoji] = (p.reactions[emoji] || 0) + 1;
          localStorage.setItem('bpc_posts', JSON.stringify(posts));
          renderPosts();
        }
      }catch(err){
        console.error(err);
        alert("Tepki eklenemedi.");
      }
    }

    // Yorum paneli a√ß/kapa
    function toggleComments(id){
      const el = document.getElementById(`comments-${id}`);
      if(!el) return;
      el.style.display = (el.style.display === 'block') ? 'none' : 'block';
    }

    // Render
    function renderPosts(){
      const container = document.getElementById('posts');
      if(!container) return;

      const html = posts.map(post=>{
        const timeStr = post.timestampISO
          ? new Date(post.timestampISO).toLocaleString('tr-TR')
          : new Date(post.createdAt || Date.now()).toLocaleString('tr-TR');

        const r = post.reactions || {};
        const like = r["üëç"] || 0;
        const heart = r["‚ù§Ô∏è"] || 0;
        const rocket = r["üöÄ"] || 0;

        const commentsHtml = (post.comments || []).map(c => `
          <div class="comment">
            <strong>${escapeHtml(c.userId)}:</strong> ${escapeHtml(c.text)} <small>(${escapeHtml(c.time || '')})</small>
          </div>
        `).join('');

        return `
          <div class="post">
            <div class="post-header">
              <img src="${escapeAttr(post.avatar || 'bpc-bird.png')}" alt="avatar"/>
              <div>
                <div class="post-user">${escapeHtml(post.userId)} <span class="user-badge">${escapeHtml(post.userId)}</span></div>
                <div class="post-time">${timeStr}</div>
              </div>
            </div>
            <div class="post-content">${escapeHtml(post.content || '')}</div>
            <div class="post-actions">
              <button class="comment-btn" onclick="toggleComments('${escapeAttr(post.id)}')">Yorum Yap</button>
              <button class="emoji-btn" onclick="addReaction('${escapeAttr(post.id)}','üëç')">üëç ${like}</button>
              <button class="emoji-btn" onclick="addReaction('${escapeAttr(post.id)}','‚ù§Ô∏è')">‚ù§Ô∏è ${heart}</button>
              <button class="emoji-btn" onclick="addReaction('${escapeAttr(post.id)}','üöÄ')">üöÄ ${rocket}</button>
            </div>
            <div id="comments-${escapeAttr(post.id)}" class="comment-section">
              ${commentsHtml}
              <div class="comment-input">
                <input type="text" id="comment-input-${escapeAttr(post.id)}" placeholder="Yorum yaz..." maxlength="280"/>
                <button onclick="addComment('${escapeAttr(post.id)}')">G√∂nder</button>
              </div>
            </div>
          </div>
        `;
      }).join('');

      container.innerHTML = html;
    }

    // XSS korumasƒ±
    function escapeHtml(text){
      const div = document.createElement('div');
      div.textContent = String(text ?? '');
      return div.innerHTML;
    }
    function escapeAttr(text){
      return String(text ?? '').replace(/"/g, '&quot;').replace(/'/g, '&#39;');
    }

    // Sayfa y√ºklenince otomatik giri≈ü
    window.addEventListener('load', ()=>{
      const savedId = localStorage.getItem('bpc_user_id');
      if(savedId){ createUser(); }
    });
  </script>
</body>
</html>
