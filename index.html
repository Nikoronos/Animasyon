async function record(){
  stopPreview();
  setCanvasSize(ui.res.value);
  const secs = clamp(+ui.dur.value || 6, 3, 10);

  ui.status.textContent = "Hazırlanıyor…";
  const mp4Mime = pickSupportedMp4Mime();
  const stream = cv.captureStream(FPS);

  let chunks = [], mime = mp4Mime || 'video/webm;codecs=vp9';

  let rec;
  try {
    rec = new MediaRecorder(stream, { mimeType: mime, videoBitsPerSecond: 6_000_000 });
  } catch(e) {
    mime = 'video/webm;codecs=vp9';
    rec = new MediaRecorder(stream, { mimeType: mime, videoBitsPerSecond: 6_000_000 });
  }

  rec.ondataavailable = e => { if (e.data && e.data.size) chunks.push(e.data); };

  // --- Kayıt başlat
  chunks = [];
  rec.start();
  t0 = performance.now();
  rafId = requestAnimationFrame(draw);

  // UI sayacı
  let elapsed = 0;
  const uiTimer = setInterval(() => {
    elapsed += 0.1;
    ui.status.textContent = `Kaydediliyor… ${elapsed.toFixed(1)}s / ${secs}s`;
  }, 100);

  // Süre dolunca durdur (kesin durdurma)
  const hardStop = setTimeout(() => {
    if (rec.state !== 'inactive') rec.stop();
  }, secs * 1000);

  // Emniyet: 2 sn sonra hâlâ kapanmadıysa zorla kapat
  const safety = setTimeout(() => {
    if (rec.state !== 'inactive') rec.stop();
  }, secs * 1000 + 2000);

  // Bittiğinde işler
  rec.onstop = async () => {
    clearInterval(uiTimer);
    clearTimeout(hardStop);
    clearTimeout(safety);
    if (rafId) cancelAnimationFrame(rafId);

    const blob = new Blob(chunks, { type: mime });

    // WEBM'i hemen indirilebilir yap (anında link)
    const webmUrl = URL.createObjectURL(blob);
    ui.dl.href = webmUrl;
    ui.dl.download = mime.startsWith('video/mp4') ? 'bpc-anim.mp4' : 'bpc-anim.webm';
    ui.dl.textContent = `İndir: ${ui.dl.download}`;
    ui.dl.style.display = 'inline-block';

    if (mime.startsWith('video/mp4')) {
      ui.status.textContent = "MP4 indirildi.";
      return;
    }

    // WEBM → MP4 dönüşüm
    try {
      ui.status.textContent = "MP4’e dönüştürülüyor… (ilk kullanımda biraz sürebilir)";
      const { createFFmpeg } = FFmpeg;
      const ffmpeg = createFFmpeg({
        log: false,
        corePath: 'https://unpkg.com/@ffmpeg/core@0.12.6/dist/ffmpeg-core.js'
      });
      await ffmpeg.load();

      const data = new Uint8Array(await blob.arrayBuffer());
      ffmpeg.FS('writeFile', 'in.webm', data);
      await ffmpeg.run(
        '-i','in.webm',
        '-c:v','libx264','-pix_fmt','yuv420p','-preset','veryfast','-crf','18',
        '-r', String(FPS),
        'out.mp4'
      );
      const out = ffmpeg.FS('readFile','out.mp4');
      const mp4Blob = new Blob([out.buffer], { type: 'video/mp4' });

      // MP4 için ikinci link
      const a = document.createElement('a');
      a.className = 'pill';
      a.href = URL.createObjectURL(mp4Blob);
      a.download = 'bpc-anim.mp4';
      a.textContent = 'İndir: bpc-anim.mp4 (dönüştürüldü)';
      a.style.marginLeft = '8px';
      ui.dl.insertAdjacentElement('afterend', a);

      ui.status.textContent = "MP4 hazır.";
    } catch (err) {
      console.error(err);
      ui.status.textContent = "Dönüştürme başarısız. Yeniden dene ya da çözünürlüğü 720 yap.";
    }
  };
}
