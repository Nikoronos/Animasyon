<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Twox Galaxy</title>
  <style>
    *{margin:0;padding:0;box-sizing:border-box;}
    body{
      font-family:'Segoe UI',Tahoma,sans-serif;
      background:#02030a;
      color:#fff;
      min-height:100vh;
    }
    .bg-stars{
      position:fixed;inset:0;
      background:
        radial-gradient(circle at 10% 20%,rgba(255,255,255,.12) 0,transparent 40%),
        radial-gradient(circle at 90% 10%,rgba(0,150,255,.08) 0,transparent 45%),
        radial-gradient(circle at 80% 80%,rgba(255,255,255,.06) 0,transparent 55%);
      opacity:.22;
      z-index:-1;
    }
    .overlay{
      min-height:100vh;
      padding:14px;
      background:radial-gradient(circle at top,#111827dd,#02030add);
    }
    .header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:8px;
      margin-bottom:10px;
    }
    .logo{
      display:flex;
      align-items:center;
      gap:8px;
    }
    .logo-icon{
      width:40px;height:40px;
      border-radius:50%;
      background:radial-gradient(circle,#00e5ff,#2563eb);
      display:flex;align-items:center;justify-content:center;
      font-weight:900;font-size:18px;color:#020817;
      box-shadow:0 0 16px rgba(56,189,248,.9);
    }
    .logo h1{font-size:1.4rem;letter-spacing:1px;margin:0;}
    .logo span{font-size:.7rem;color:#9ca3af;}
    #logoutBtn{
      display:none;
      padding:8px 14px;
      border:none;
      border-radius:999px;
      background:#ef4444;
      color:#fff;
      font-weight:600;
      cursor:pointer;
      font-size:.8rem;
    }

    .auth{
      margin:50px auto 0;
      max-width:340px;
      padding:16px 14px 18px;
      background:rgba(15,23,42,.96);
      border-radius:18px;
      box-shadow:0 10px 30px rgba(15,23,42,.9);
      text-align:center;
    }
    .auth h2{font-size:1.3rem;margin-bottom:4px;}
    .auth p{font-size:.8rem;color:#9ca3af;margin-bottom:6px;}
    .auth input{
      width:100%;
      padding:10px 12px;
      border-radius:12px;
      border:none;
      margin:8px 0;
      font-size:.9rem;
    }
    .auth button{
      padding:9px 14px;
      border:none;
      border-radius:12px;
      background:#22c55e;
      color:#fff;
      font-weight:700;
      cursor:pointer;
      width:100%;
      margin-top:4px;
      font-size:.9rem;
    }
    .auth small{display:block;margin-top:6px;color:#6b7280;font-size:.7rem;}

    #app{display:none;}

    .top-row{
      display:flex;
      flex-direction:column;
      gap:6px;
      margin-bottom:8px;
    }
    .user-label{font-size:.8rem;color:#9ca3af;}
    .user-label span{color:#38bdf8;font-weight:600;}

    .planets-bar{
      display:flex;
      gap:6px;
      overflow-x:auto;
      padding:6px 2px 4px;
      scrollbar-width:none;
    }
    .planets-bar::-webkit-scrollbar{display:none;}
    .planet-btn{
      flex:0 0 auto;
      padding:6px 9px;
      border-radius:999px;
      border:1px solid transparent;
      font-size:.7rem;
      display:flex;
      align-items:center;
      gap:4px;
      cursor:pointer;
      background:rgba(15,23,42,.9);
      color:#9ca3af;
      transition:.18s;
      white-space:nowrap;
    }
    .planet-btn span.emoji{font-size:.9rem;}
    .planet-btn.active{
      color:#fff;
      border-color:#38bdf8;
      box-shadow:0 0 10px rgba(56,189,248,.6);
      background:linear-gradient(to right,#111827,#0f172add);
    }
    .planet-label{font-size:.7rem;color:#6b7280;margin-left:3px;}

    .post-form{
      margin-top:6px;
      padding:10px;
      background:rgba(15,23,42,.98);
      border-radius:16px;
      box-shadow:0 6px 18px rgba(15,23,42,.9);
    }
    .post-form-title{font-size:.8rem;color:#9ca3af;margin-bottom:4px;}
    #postContent{
      width:100%;
      min-height:72px;
      resize:vertical;
      padding:9px 10px;
      border-radius:12px;
      border:none;
      font-size:.9rem;
      color:#111827;
      background:#f9fafb;
      outline:none;
    }
    .form-row{
      display:flex;
      align-items:center;
      gap:6px;
      margin-top:6px;
      flex-wrap:wrap;
    }
    .char-counter{font-size:.7rem;color:#9ca3af;margin-right:auto;}
    .emoji-toggle{
      padding:6px 10px;
      border-radius:18px;
      border:none;
      background:#111827;
      color:#e5e7eb;
      cursor:pointer;
      font-size:.75rem;
    }
    .emoji-panel{
      position:absolute;
      top:100%;
      right:0;
      margin-top:4px;
      background:#020817;
      border-radius:12px;
      padding:6px;
      display:none;
      box-shadow:0 10px 25px rgba(15,23,42,.95);
      z-index:50;
      max-height:230px;
      overflow-y:auto;
      width:170px;
    }
    .emoji-panel button{
      display:block;
      width:100%;
      text-align:left;
      padding:4px 6px;
      border:none;
      background:transparent;
      color:#e5e7eb;
      font-size:1rem;
      cursor:pointer;
    }
    .send-btn{
      padding:7px 12px;
      border-radius:14px;
      border:none;
      background:#38bdf8;
      color:#020817;
      font-weight:800;
      cursor:pointer;
      font-size:.8rem;
    }

    #posts{
      margin-top:10px;
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .planet-empty{
      font-size:.75rem;
      color:#6b7280;
      padding:6px 2px;
    }

    .post{
      padding:9px;
      background:rgba(9,9,20,.98);
      border-radius:14px;
      border:1px solid rgba(75,85,99,.7);
      box-shadow:0 4px 14px rgba(15,23,42,.9);
      font-size:.8rem;
    }
    .post-header{
      display:flex;
      align-items:center;
      gap:7px;
      margin-bottom:4px;
    }
    .post-avatar{
      width:26px;height:26px;
      border-radius:50%;
      background:radial-gradient(circle,#38bdf8,#0f172a);
      display:flex;align-items:center;justify-content:center;
      font-size:.6rem;font-weight:800;color:#020817;
    }
    .post-user-line{
      display:flex;
      align-items:center;
      gap:4px;
      flex-wrap:wrap;
    }
    .post-user-id{
      font-weight:700;
      color:#e5e7eb;
      font-size:.78rem;
    }
    .badge-mod{
      padding:1px 6px;
      border-radius:7px;
      background:#f97316;
      font-size:.6rem;
      color:#111827;
      font-weight:700;
    }
    .badge-planet{
      padding:1px 6px;
      border-radius:7px;
      background:#111827;
      font-size:.55rem;
      color:#38bdf8;
    }
    .post-time{font-size:.6rem;color:#6b7280;}
    .post-content{
      margin-top:4px;
      padding:7px 8px;
      border-radius:10px;
      background:#f9fafb;
      color:#111827;
      font-size:.8rem;
      word-wrap:break-word;
      white-space:pre-wrap;
    }

    .post-actions{
      display:flex;
      gap:6px;
      margin-top:5px;
      flex-wrap:wrap;
      align-items:center;
    }
    .btn-mini{
      padding:3px 7px;
      border-radius:9px;
      border:none;
      font-size:.65rem;
      cursor:pointer;
      background:#111827;
      color:#e5e7eb;
    }
    .btn-mini span.count{margin-left:3px;color:#38bdf8;}
    .btn-mini:hover{background:#020817;}

    .comment-box{
      display:none;
      margin-top:5px;
      padding:5px;
      border-radius:10px;
      background:#020817;
      border:1px solid #111827;
    }
    .comment{
      font-size:.7rem;
      padding:3px 4px;
      margin-bottom:3px;
      border-radius:6px;
      background:#020111;
      color:#e5e7eb;
    }
    .comment strong{color:#38bdf8;}
    .reply{
      font-size:.65rem;
      margin-left:14px;
      padding:2px 4px;
      border-radius:5px;
      background:#050816;
      color:#cbd5f5;
      margin-top:2px;
    }
    .comment-actions{
      margin-top:1px;
      display:flex;
      gap:8px;
      font-size:.6rem;
      color:#6b7280;
    }
    .comment-actions button{
      border:none;
      background:none;
      padding:0;
      font-size:.6rem;
      color:#38bdf8;
      cursor:pointer;
    }
    .comment-input-row,
    .reply-input-row{
      display:flex;
      gap:4px;
      margin-top:3px;
    }
    .comment-input-row input,
    .reply-input-row input{
      flex:1;
      padding:4px 6px;
      border-radius:8px;
      border:none;
      font-size:.7rem;
    }
    .comment-input-row button,
    .reply-input-row button{
      padding:4px 7px;
      border-radius:8px;
      border:none;
      font-size:.65rem;
      background:#22c55e;
      color:#020817;
      cursor:pointer;
      font-weight:700;
    }

    @media(min-width:768px){
      .overlay{max-width:540px;margin:0 auto;}
    }
  </style>
</head>
<body>
<div class="bg-stars"></div>
<div class="overlay">
  <div class="header">
    <div class="logo">
      <div class="logo-icon">TX</div>
      <div>
        <h1>Twox Galaxy</h1>
        <span>Earth ‚Ä¢ Mars ‚Ä¢ Kepler</span>
      </div>
    </div>
    <button id="logoutBtn" onclick="logout()">Logout</button>
  </div>

  <div id="auth" class="auth">
    <h2>Welcome Pioneer</h2>
    <p>BPC ID ile giri≈ü yap. √ñrnek: <code>BPC123456</code>.<br>Bo≈ü bƒ±rakƒ±rsan senin i√ßin ID √ºretiriz.</p>
    <input id="accessCode" type="text" placeholder="Enter your BPC ID or leave empty">
    <button onclick="loginWithCode()">Enter Twox Galaxy</button>
    <small>Moderator ID: BPC545776</small>
  </div>

  <div id="app">
    <div class="top-row">
      <div class="user-label">You are logged in as <span id="currentUserId"></span></div>
      <div>
        <div class="planet-label">Choose your planet (you can post in all three):</div>
        <div id="planetsBar" class="planets-bar"></div>
      </div>
    </div>

    <div class="post-form">
      <div class="post-form-title">
        <span id="currentPlanetLabel"></span> ‚Äî Share your Twox (max 220 chars)
      </div>
      <textarea id="postContent" placeholder="Type a short Twox..."></textarea>
      <div class="form-row">
        <div class="char-counter"><span id="charCount">0</span>/220</div>
        <div style="position:relative;">
          <button class="emoji-toggle" onclick="toggleEmojiPanel()">Emoji</button>
          <div id="emojiPanel" class="emoji-panel">
            <button onclick="addEmoji('üòÄ')">üòÄ</button>
            <button onclick="addEmoji('üòÅ')">üòÅ</button>
            <button onclick="addEmoji('üòÇ')">üòÇ</button>
            <button onclick="addEmoji('ü§£')">ü§£</button>
            <button onclick="addEmoji('üòä')">üòä</button>
            <button onclick="addEmoji('üòç')">üòç</button>
            <button onclick="addEmoji('üòé')">üòé</button>
            <button onclick="addEmoji('üò¢')">üò¢</button>
            <button onclick="addEmoji('üò°')">üò°</button>
            <button onclick="addEmoji('üëç')">üëç</button>
            <button onclick="addEmoji('üëé')">üëé</button>
            <button onclick="addEmoji('üëè')">üëè</button>
            <button onclick="addEmoji('üôè')">üôè</button>
            <button onclick="addEmoji('üî•')">üî•</button>
            <button onclick="addEmoji('‚≠ê')">‚≠ê</button>
            <button onclick="addEmoji('üåç')">üåç</button>
            <button onclick="addEmoji('üî¥')">üî¥</button>
            <button onclick="addEmoji('ü™ê')">ü™ê</button>
            <button onclick="addEmoji('üöÄ')">üöÄ</button>
            <button onclick="addEmoji('üí¨')">üí¨</button>
          </div>
        </div>
        <button class="send-btn" onclick="createPost()">Post</button>
      </div>
    </div>

    <div id="posts"></div>
  </div>
</div>

<!-- Cache kƒ±rƒ±cƒ±: ?v yoksa otomatik ekler -->
<script type="module">
  if (!location.search.includes("v=")) {
    const url = new URL(location.href);
    url.searchParams.set("v", Date.now());
    location.replace(url.toString());
  }
</script>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
  import {
    getDatabase, ref, push, set, onValue, get, remove
  } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-database.js";

  // >>> BURAYA KENDƒ∞ FIREBASE WEB CONFIG'ƒ∞Nƒ∞ YAPI≈ûTIR <<<
  const firebaseConfig = {
    apiKey: "BURAYA_API_KEY",
    authDomain: "bpc-social.firebaseapp.com",
    databaseURL: "https://bpc-social-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "bpc-social",
    storageBucket: "bpc-social.appspot.com",
    messagingSenderId: "BURAYA_SENDER_ID",
    appId: "BURAYA_APP_ID"
  };

  const app = initializeApp(firebaseConfig);
  const db  = getDatabase(app);

  const PLANETS = [
    { key:"earth",  name:"Earth",  emoji:"üåç" },
    { key:"mars",   name:"Mars",   emoji:"üî¥" },
    { key:"kepler", name:"Kepler", emoji:"ü™ê" }
  ];
  const MAX_CHARS = 220;
  const MOD_ID = "BPC545776";
  const MIN_INTERVAL = 3000;

  let lastPostTime = 0;
  let currentUser = null;
  let currentPlanet = "earth";
  let unsubscribe = null;

  const authEl             = document.getElementById("auth");
  const appEl              = document.getElementById("app");
  const currentUserSpan    = document.getElementById("currentUserId");
  const planetsBar         = document.getElementById("planetsBar");
  const currentPlanetLabel = document.getElementById("currentPlanetLabel");
  const postsEl            = document.getElementById("posts");
  const logoutBtn          = document.getElementById("logoutBtn");
  const postContentEl      = document.getElementById("postContent");
  const charCountEl        = document.getElementById("charCount");
  const emojiPanel         = document.getElementById("emojiPanel");

  function escapeHtml(t){
    const d=document.createElement("div");
    d.textContent=t||"";
    return d.innerHTML;
  }
  function generateBPCID(){
    return "BPC" + Math.floor(100000 + Math.random()*900000);
  }

  // LOGIN
  window.loginWithCode = function(){
    const input = document.getElementById("accessCode");
    const typedRaw = (input.value || "").trim();
    const typed = typedRaw.toUpperCase();
    const saved = localStorage.getItem("twox_user_id");

    if(!typed && saved){ initUser(saved); return; }
    if(!typed && !saved){
      const id = generateBPCID();
      alert("Your new Twox ID:\n" + id + "\nBunu kaybetme.");
      localStorage.setItem("twox_user_id", id);
      initUser(id);
      return;
    }

    const isMod   = (typed === MOD_ID);
    const isValid = /^BPC\d{6}$/.test(typed);
    if(!isMod && !isValid){
      alert("Invalid ID. Use BPC123456 format.");
      return;
    }

    if(saved && saved !== typed){
      const ok = confirm(
        "This device already has ID: " + saved + "\nReplace with: " + typed + " ?"
      );
      if(!ok){ initUser(saved); return; }
    }

    localStorage.setItem("twox_user_id", typed);
    initUser(typed);
  };

  function initUser(id){
    currentUser = { id };
    authEl.style.display    = "none";
    appEl.style.display     = "block";
    logoutBtn.style.display = "inline-block";
    currentUserSpan.textContent = id;
    renderPlanetsBar();
    selectPlanet("earth");
    setupCharCounter();
  }

  window.logout = function(){
    localStorage.removeItem("twox_user_id");
    location.reload();
  };

  window.addEventListener("load", () => {
    const saved = localStorage.getItem("twox_user_id");
    if(saved){ initUser(saved); }
  });

  // PLANETS
  function renderPlanetsBar(){
    planetsBar.innerHTML = "";
    PLANETS.forEach(p=>{
      const btn = document.createElement("button");
      btn.className = "planet-btn";
      btn.dataset.planet = p.key;
      btn.innerHTML = `<span class="emoji">${p.emoji}</span>${p.name}`;
      btn.onclick = () => selectPlanet(p.key);
      planetsBar.appendChild(btn);
    });
    updatePlanetButtons();
  }

  function updatePlanetButtons(){
    planetsBar.querySelectorAll(".planet-btn").forEach(b=>{
      if(b.dataset.planet === currentPlanet) b.classList.add("active");
      else b.classList.remove("active");
    });
    const p = PLANETS.find(pl => pl.key === currentPlanet);
    currentPlanetLabel.textContent = "Planet: " + (p ? p.name : currentPlanet);
  }

  function selectPlanet(key){
    currentPlanet = key;
    updatePlanetButtons();
    listenPostsForPlanet(key);
  }

  // CHAR COUNTER
  function updateCharCount(){
    let v = postContentEl.value || "";
    if(v.length > MAX_CHARS){
      v = v.slice(0, MAX_CHARS);
      postContentEl.value = v;
    }
    charCountEl.textContent = v.length;
  }
  function setupCharCounter(){
    postContentEl.addEventListener("input", updateCharCount);
    updateCharCount();
  }

  // EMOJI
  window.toggleEmojiPanel = function(){
    emojiPanel.style.display =
      (emojiPanel.style.display === "block") ? "none" : "block";
  };
  window.addEmoji = function(emoji){
    let v = postContentEl.value || "";
    const add = (v && !v.endsWith(" ")) ? (" " + emoji) : emoji;
    v = (v + add).slice(0, MAX_CHARS);
    postContentEl.value = v;
    updateCharCount();
    emojiPanel.style.display = "none";
  };

  // CREATE POST
  window.createPost = function(){
    if(!currentUser){ alert("Login first."); return; }

    const now = Date.now();
    if(now - lastPostTime < MIN_INTERVAL){
      alert("Slow down pioneer.");
      return;
    }

    let content = (postContentEl.value || "").trim();
    if(!content) return;
    if(content.length > MAX_CHARS) content = content.slice(0, MAX_CHARS);

    const postsRef = ref(db, "planets/" + currentPlanet + "/posts");
    const newRef   = push(postsRef);

    set(newRef, {
      userId: currentUser.id,
      planet: currentPlanet,
      content,
      timestamp: now
    }).then(()=>{
      lastPostTime = now;
      postContentEl.value = "";
      updateCharCount();
    }).catch(e=>{
      alert("Post failed: " + (e.code || "") + " " + (e.message || ""));
      console.error(e);
    });
  };

  // LISTEN & RENDER
  function listenPostsForPlanet(planetKey){
    if(typeof unsubscribe === "function"){ unsubscribe(); unsubscribe=null; }

    const postsRef = ref(db, "planets/" + planetKey + "/posts");
    unsubscribe = onValue(postsRef, snapshot => {
      const posts = [];
      snapshot.forEach(child => {
        const v = child.val() || {};
        posts.push({
          id: child.key,
          userId: v.userId || "",
          planet: v.planet || planetKey,
          content: v.content || "",
          timestamp: v.timestamp || 0,
          comments: v.comments || {},
          reactions: v.reactions || {}
        });
      });
      posts.sort((a,b)=>b.timestamp - a.timestamp);
      renderPosts(planetKey, posts);
    }, error => {
      console.error("onValue error:", error);
      alert("Read error: " + (error.code || ""));
    });
  }

  function renderPosts(planetKey, posts){
    postsEl.innerHTML = "";
    if(!posts.length){
      const p = PLANETS.find(pl => pl.key === planetKey);
      const empty = document.createElement("div");
      empty.className = "planet-empty";
      empty.textContent = "No Twox yet on " + (p ? p.name : planetKey) + ".";
      postsEl.appendChild(empty);
      return;
    }
    posts.forEach(p => postsEl.appendChild(buildPostElement(p)));
  }

  function buildPostElement(p){
    const planet = PLANETS.find(pl => pl.key === p.planet) ||
                   PLANETS.find(pl => pl.key === currentPlanet) ||
                   {name:p.planet || "Unknown", emoji:"ü™ê"};
    const planetKey = p.planet || planet.key || currentPlanet;

    const card = document.createElement("div");
    card.className = "post";

    // Header
    const header = document.createElement("div");
    header.className = "post-header";

    const avatar = document.createElement("div");
    avatar.className = "post-avatar";
    avatar.textContent = planet.emoji;

    const infoBox = document.createElement("div");
    const userLine = document.createElement("div");
    userLine.className = "post-user-line";

    const userIdSpan = document.createElement("div");
    userIdSpan.className = "post-user-id";
    userIdSpan.textContent = p.userId;

    userLine.appendChild(userIdSpan);
    if(p.userId === MOD_ID){
      const mod = document.createElement("div");
      mod.className = "badge-mod";
      mod.textContent = "MOD";
      userLine.appendChild(mod);
    }
    const planetBadge = document.createElement("div");
    planetBadge.className = "badge-planet";
    planetBadge.textContent = planet.name;
    userLine.appendChild(planetBadge);

    const timeDiv = document.createElement("div");
    timeDiv.className = "post-time";
    if(p.timestamp){
      timeDiv.textContent = new Date(p.timestamp).toLocaleString("en-GB",{
        day:"2-digit",month:"2-digit",hour:"2-digit",minute:"2-digit"
      });
    }

    infoBox.appendChild(userLine);
    infoBox.appendChild(timeDiv);

    header.appendChild(avatar);
    header.appendChild(infoBox);

    // Content
    const contentDiv = document.createElement("div");
    contentDiv.className = "post-content";
    contentDiv.innerHTML = escapeHtml(p.content);

    // Actions
    const actions = document.createElement("div");
    actions.className = "post-actions";

    // Like / Rocket
    const likeCount = countReactions(p.reactions, "like");
    const likeBtn = document.createElement("button");
    likeBtn.className = "btn-mini";
    likeBtn.textContent = "üöÄ";
    const likeSpan = document.createElement("span");
    likeSpan.className = "count";
    likeSpan.textContent = likeCount;
    likeBtn.appendChild(likeSpan);
    likeBtn.onclick = () => toggleLike(planetKey, p.id);
    actions.appendChild(likeBtn);

    // Comments toggle
    const commentsTotal = countComments(p.comments || {});
    const cBtn = document.createElement("button");
    cBtn.className = "btn-mini";
    cBtn.textContent = "üí¨ Comments (" + commentsTotal + ")";
    cBtn.onclick = () => toggleComments(planetKey, p.id);
    actions.appendChild(cBtn);

    // Comment box
    const commentBox = document.createElement("div");
    commentBox.className = "comment-box";
    commentBox.id = "comments-" + planetKey + "-" + p.id;

    // Yorumlarƒ± √ßiz
    Object.entries(p.comments || {}).forEach(([cid, c]) => {
      const com = document.createElement("div");
      com.className = "comment";
      com.innerHTML =
        "<strong>" + escapeHtml(c.userId || "") + ":</strong> " +
        escapeHtml(c.text || "");

      const ca = document.createElement("div");
      ca.className = "comment-actions";

      const replyBtn = document.createElement("button");
      replyBtn.textContent = "Reply";
      replyBtn.onclick = () => showReplyInput(planetKey, p.id, cid);
      ca.appendChild(replyBtn);

      com.appendChild(ca);

      // Replies
      if(c.replies){
        Object.values(c.replies).forEach(r => {
          const rEl = document.createElement("div");
          rEl.className = "reply";
          rEl.innerHTML =
            "<strong>" + escapeHtml(r.userId || "") + ":</strong> " +
            escapeHtml(r.text || "");
          com.appendChild(rEl);
        });
      }

      commentBox.appendChild(com);
    });

    // Comment input
    const ciRow = document.createElement("div");
    ciRow.className = "comment-input-row";
    const ciInput = document.createElement("input");
    ciInput.type = "text";
    ciInput.placeholder = "Write a comment...";
    ciInput.id = "comment-input-" + planetKey + "-" + p.id;
    const ciBtn = document.createElement("button");
    ciBtn.textContent = "Send";
    ciBtn.onclick = () => addComment(planetKey, p.id);
    ciRow.appendChild(ciInput);
    ciRow.appendChild(ciBtn);
    commentBox.appendChild(ciRow);

    card.appendChild(header);
    card.appendChild(contentDiv);
    card.appendChild(actions);
    card.appendChild(commentBox);

    return card;
  }

  function countReactions(reactions, type){
    if(!reactions || !reactions[type]) return 0;
    return Object.keys(reactions[type]).length;
  }
  function countComments(comments){
    let total = 0;
    Object.values(comments).forEach(c => {
      total++;
      if(c.replies) total += Object.keys(c.replies).length;
    });
    return total;
  }

  // TOGGLES
  window.toggleComments = function(planetKey, postId){
    const box = document.getElementById("comments-" + planetKey + "-" + postId);
    if(!box) return;
    box.style.display = (box.style.display === "block") ? "none" : "block";
  };

  // COMMENT ADD
  window.addComment = function(planetKey, postId){
    if(!currentUser){ alert("Login first."); return; }
    const input = document.getElementById("comment-input-" + planetKey + "-" + postId);
    if(!input) return;
    const text = (input.value || "").trim();
    if(!text) return;

    const commentsRef = ref(db,
      "planets/" + planetKey + "/posts/" + postId + "/comments");
    push(commentsRef, {
      userId: currentUser.id,
      text,
      time: Date.now()
    }).then(()=>{ input.value = ""; })
     .catch(e=>{
       alert("Comment failed: " + (e.code || ""));
       console.error(e);
     });
  };

  // SHOW REPLY INPUT
  window.showReplyInput = function(planetKey, postId, commentId){
    if(!currentUser){ alert("Login first."); return; }
    const box = document.getElementById("comments-" + planetKey + "-" + postId);
    if(!box) return;
    const rowId = "reply-input-" + planetKey + "-" + postId + "-" + commentId;
    if(document.getElementById(rowId)) return;

    const row = document.createElement("div");
    row.className = "reply-input-row";
    row.id = rowId;

    const inp = document.createElement("input");
    inp.type = "text";
    inp.placeholder = "Reply to this comment...";

    const btn = document.createElement("button");
    btn.textContent = "Send";
    btn.onclick = () => addReply(planetKey, postId, commentId, rowId, inp);

    row.appendChild(inp);
    row.appendChild(btn);

    // ilgili comment elementine ekle
    const comments = box.getElementsByClassName("comment");
    for(const c of comments){
      if(c.innerHTML.includes(commentId)) { // eski data yoksa fallback
        c.appendChild(row);
        return;
      }
    }
    box.appendChild(row);
  };

  // ADD REPLY
  window.addReply = function(planetKey, postId, commentId, rowId, inputEl){
    if(!currentUser) return;
    const text = (inputEl.value || "").trim();
    if(!text) return;

    const repliesRef = ref(db,
      "planets/" + planetKey + "/posts/" + postId +
      "/comments/" + commentId + "/replies");

    push(repliesRef, {
      userId: currentUser.id,
      text,
      time: Date.now()
    }).then(()=>{
      inputEl.value = "";
      const row = document.getElementById(rowId);
      if(row) row.remove();
    }).catch(e=>{
      alert("Reply failed: " + (e.code || ""));
      console.error(e);
    });
  };

  // LIKE TOGGLE
  window.toggleLike = function(planetKey, postId){
    if(!currentUser){ alert("Login first."); return; }
    const likeRef = ref(db,
      "planets/" + planetKey + "/posts/" + postId +
      "/reactions/like/" + currentUser.id);

    get(likeRef).then(snap=>{
      if(snap.exists()){
        // unlike
        remove(likeRef);
      }else{
        set(likeRef, true);
      }
    }).catch(e=>{
      console.error(e);
    });
  };
</script>
</body>
</html>
